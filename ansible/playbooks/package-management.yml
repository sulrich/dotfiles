---
# package-management.yml - ansible playbook for installing/updating
# ubuntu/debian packages supports both "lite" and "standard" package lists via
# command line flag

- name: install and update ubuntu/debian packages
  hosts: all
  become: yes
  vars_files:
    - vars/packages.yml
  vars:
    # default to standard packages unless overridden
    lite_packages: false
    # determine which package list to use
    selected_packages: "{{ packages_lite if lite_packages else packages_standard }}"

  tasks:
    - name: detect os family
      set_fact:
        is_debian: "{{ ansible_os_family == 'Debian' }}"
        is_ubuntu: "{{ ansible_distribution == 'Ubuntu' }}"

    - name: fail if not debian/ubuntu
      fail:
        msg: "this playbook only supports debian/ubuntu systems"
      when: not is_debian

    - name: display package installation mode
      debug:
        msg: |
          installing {{ 'lite' if lite_packages else 'standard' }} package set
          total packages: {{ selected_packages | length }}

    - name: update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: install/update selected packages
      apt:
        name: "{{ selected_packages }}"
        state: latest
        install_recommends: no
      register: package_install_result

    - name: display installation results
      debug:
        msg: |
          package installation complete
          packages installed/updated: {{ package_install_result.changed | default(false) }}

    # docker installation following official ubuntu docs
    - name: remove conflicting docker packages
      apt:
        name:
          - docker.io
          - docker-doc
          - docker-compose
          - docker-compose-v2
          - podman-docker
          - containerd
          - runc
        state: absent

    - name: create docker keyring directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: download docker gpg key
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: get system architecture
      command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: add docker repository
      apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: update apt cache for docker
      apt:
        update_cache: yes

    - name: install docker packages
      apt:
        name: "{{ packages_docker }}"
        state: latest

    - name: start and enable docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
      when: ansible_user is defined

    - name: verify docker installation
      command: docker --version
      register: docker_version
      changed_when: false

    - name: verify docker compose installation
      command: docker compose version
      register: docker_compose_version
      changed_when: false

    - name: display docker installation results
      debug:
        msg: |
          docker installation complete:
          {{ docker_version.stdout }}
          {{ docker_compose_version.stdout }}

    - name: clean up apt cache
      apt:
        autoclean: yes
        autoremove: yes

    - name: display completion message
      debug:
        msg: |
          package management complete!
          {{ selected_packages | length }} packages processed
          use 'dpkg -l | grep ^ii | wc -l' to see total installed packages
